<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: product/productInstance.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: product/productInstance.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Класс отвечает за взаимодействие верскти с конкретным
 * экземпляром Product()
 */
var $ = require('jquery');
var _ = require('lodash');

var EventBus = require('../events/events');

var ProductInstance = function (_owner, $product) {
  var self = this;

  self.selectors = {
    //  селектор формы
    product: 'data-product-id',
    item: 'data-item-id',
    // data атрибут нативного селекта
    nativeSelect: 'data-product-variants',
    // data атрибут блока в который происходит рендер модификаций
    optionSelector: 'data-option-selector',

    quantity: 'data-quantity',
    quantityButton: 'data-quantity-change'
  }

  // настройки для экземпляра
  self._owner = _owner;

  self.settings = self._owner.settings;
  self.product = self._owner;
  self.quantity = {};

  self.type = 'product';

  self.$product = $product;

  // прибиваем экземпляр к узлу
  $product[0].Product = self;

  self._init ();
};

/**
 * Инициализация связки
 */
ProductInstance.prototype._init = function () {
  var self = this;

  // привязываем нужные объекты
  self.variants = new (require('./tree')) (self);
  self._initQuantity();
  self.price_kinds = new (require('./priceTypes')) (self);

  if (self.$product.data('item-id')) {
    self.type = 'item';
  }

  self._initOptionSelectors();
  self._bindUpdateCart();
};

/**
 * Инициализация селектора
 */
ProductInstance.prototype._initOptionSelectors = function () {
  var self = this;
  var _isActive = _.isObject(self.optionSelector);

  self._hasSelector = self.$product.find('['+ self.selectors.nativeSelect +']').length ? true : false;

  if (!self._hasSelector) {
    return false;
  }

  if (!_isActive) {
    // У нас нет активных селекторов
    // заряжаем
    self.optionSelector = new (require('./optionSelector')) (self);
  } else {
    // данный селектор активен
    // наверное оти перезаписать настройки
    self.optionSelector._init();
  }

  // Дергаем вариант
  if (self.product.settings.initOption) {
    self.variants._update();
  }
};

/**
 * Инициализация счетчиков
 */
ProductInstance.prototype._initQuantity = function () {
  var self = this;
  var $quantity = self.$product.find('['+ self.selectors.quantity +']');

  $quantity.each(function (index) {
    self.quantity[index] = new (require('./quantity')) (self, this);
  });
};

/**
 * Получаем конкретный экземпляр.
 * Возвращет экземпляр, либо false
 */
ProductInstance.prototype.getInstance = function ($object) {
  var self = this;
  var instance;

  if (_.isObject($object[0].Product)) {
    instance = $object[0];
  } else {
    instance = $object.parents('['+ self.selectors.product +']:first')[0];
  }

  if (!instance) {
    instance = false;
  } else {
    instance = instance.Product
  }

  return instance;
};

/**
 * Обновление состояния
 * Должна сама забирать всю информацию из компонентов и обновлять
 * максимум - получить линк на quantity, откуда брать актуальную инфу
 * о кол-ве
 */
ProductInstance.prototype._updateStatus = function (status) {
  var self = this;
  var _variant;
  var _quantity;
  var _atCart;
  var _$input;

  // если обновление вызвала смена варианта, то обновляем чиселку
  // и убиваем поток
  _$input = self.quantity[0];

  // если в верстке не указан контейнеры со счетчиками - отваливаемся
  if (_$input === undefined) {
    console.warn('Product: Quantity', 'Не указан блок "Количество товаров" для ', self.$product);
    return false;
  }

  if (status.event == 'update_variant') {
    _$input.setVariant(self.variants.getVariant());
    return false;
  };

  // немного магии
  if (self._hasSelector) {
    // если в инстансе есть селектор
    _variant = self.variants.getVariant();
    _quantity = _$input.get();
    _$input = _$input.$input;
  } else {
    // если у нас куча считалок
    _variant = status.instance.variant;
    _quantity = status.instance.get();
    _$input = status.instance.$input;
  }

  _atCart = Cart.order.getItemByID(_variant.id);

  if (_atCart &amp;&amp; self.settings &amp;&amp; self.type != 'item') {
    _quantity += _atCart.quantity;
  }

  // получаем тип цены
  var _price = self.price_kinds.getPrice({
    variantId: _variant.id,
    quantity: _quantity.current
  });

  // формируем действие
  _variant.action = {
    method: status.method,
    product: self.$product,
    price: _price,
    quantity: _quantity,
    quantityInput: _$input
  };

  EventBus.publish('before:insales:'+ self.type, _variant);

  if (status.event != 'update_variant') {
    EventBus.publish(status.event +':insales:'+ self.type, _variant);
  }

  EventBus.publish('update_variant:insales:'+ self.type, _variant);

  EventBus.publish('always:insales:'+ self.type, _variant);
};

/**
 * Слушатель на обновление корзины
 */
ProductInstance.prototype._bindUpdateCart = function () {
  var self = this;

  EventBus.subscribe('update_items:insales:cart', function (data) {
    if (data.action.method != 'init') {
      _.forEach(self.quantity, function (quantity) {
        // Добавлен дебаунс для предотвращени
        _.debounce(quantity._update, 200);
      });
    }
  });
};

module.exports = ProductInstance;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="cart_.html">ajaxAPI/cart</a></li><li><a href="checkout.html">ajaxAPI/checkout</a></li><li><a href="collection.html">ajaxAPI/collection</a></li><li><a href="compare_.html">ajaxAPI/compare</a></li><li><a href="product.html">ajaxAPI/product</a></li><li><a href="shop.html">ajaxAPI/shop</a></li><li><a href="RegTools.html">tools/RegTools</a></li><li><a href="singletone.html">tools/singletone</a></li><li><a href="translit.html">tools/translit</a></li></ul><h3>Classes</h3><ul><li><a href="Cart.html">Cart</a></li><li><a href="Cart.order.html">order</a></li><li><a href="Cart.quickCheckout.html">quickCheckout</a></li><li><a href="Cart.ui.html">ui</a></li><li><a href="Compare.html">Compare</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="Product_.html">Product</a></li><li><a href="ProductPriceType.html">ProductPriceType</a></li><li><a href="Products.html">Products</a></li><li><a href="ProductVariants.html">ProductVariants</a></li><li><a href="Search.html">Search</a></li><li><a href="Shop_.html">Shop</a></li><li><a href="Shop.client.html">client</a></li><li><a href="Shop.money.html">money</a></li><li><a href="Template.html">Template</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Fri Jul 22 2016 17:00:02 GMT+0300 (MSK)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
