<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: product/quantity.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: product/quantity.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Класс для работы с полем кол-во товара
 */
var $ = require('jquery');
var _ = require('lodash');

var EventBus = require('../events/events');

var ProductQuantity = function (_owner, _quantityNode) {
  var self = this;

  // задаем базывае
  self._owner = _owner;
  self.settings = self._owner.settings;
  self.selectors = self._owner.selectors;
  self.variant = {};

  self.quantity = {
    current: 0,
    toCheck: 0,
    max: 10000000,
    min: 0
  };
  self.unit = 'pce';
  self.decimal = 0;

  // привязываем узел
  self.node = _quantityNode;
  self.$node = $(_quantityNode);
  // сохраняем линк на наше поле ввода
  self.$input = self.$node.find('input[name]');

  // привязываем экземпляр к узлу
  _quantityNode.Quantity = self;

  self._init();
};

/**
 * Инициализаций
 */
ProductQuantity.prototype._init = function () {
  var self = this;
  var _settings;
  var _variant;

  // снимаем с конфиги
  _settings = self._getConfig();

  self.quantity = {
    current: self._getQuantity(),
    toCheck: self._getQuantity()
  };

  // уточняем из товара единицу измерения
  self.unit = self._owner.product.unit;

  // определяем точность
  self.decimal = _.toInteger(self.settings.decimal[self.unit]) || 0;

  // определяем, с каким вариантом мы работаем
  if (_settings.variantId) {
    self.variant = self._owner.variants.getVariantById(_settings.variantId);
  } else {
    self.variant = self._owner.variants.getVariant();
  }

  // определяем максимум
  if (self.variant.quantity &amp;&amp; self.settings.useMax) {
    self.quantity.max = self._fixValue(self.variant.quantity);
  }

  // шаг
  self.step = self._fixValue(_settings.step || Math.pow(10, -1 * self.decimal));
  // определяем минимальное кол-во
  self.quantity.min = self._fixValue(_settings.min || self.step);

  self._check();
  self._bindEvents();
};

/**
 * Забираем data- из поля ввода
 * data-quantity - '' или id variant
 * data-step - шаг
 * data-min - минимальное
 */
ProductQuantity.prototype._getConfig = function () {
  var self = this;
  var _config = self.$node.data() || {};
  var _name = _.words(self.$input.attr('name'));
  var _variant;

  if (_name[0] == 'variant' || _name[0] == 'cart') {
    _config.variantId = _.toInteger(_name[2]);
  }

  return _config;
};

/**
 * Забираем текущее значение
 */
ProductQuantity.prototype._getQuantity = function () {
  var self = this;

  var _value = self.$input.val();
  // TODO: исправить! у нас может быть форма без инпутов???
  _value = _value ? _value.replace(',', '.').replace(/[^0-9.]/g, '') : 1;

  return self._fixValue(_value);
};

/**
 * Указываем вариант, с которым работаем ???
 */
ProductQuantity.prototype.setVariant = function (variant) {
  var self = this;

  self.variant = variant;
  self._check();
};

/**
 * Получение текущего количества и прочей инфы
 */
ProductQuantity.prototype.get = function () {
  var self = this;
  var _quantity = _.clone(self.quantity);
  _.unset(_quantity, 'toCheck');

  if (!self.settings.useMax) {
    _.unset(_quantity, 'max');
  }

  return _quantity;
};

/**
* Добавляем значение по клику на кнопку
*/
ProductQuantity.prototype._changeQuantity = function (value) {
  var self = this;

  self.quantity.toCheck += self._fixValue(value);

  self._check();
};

/**
 * Устанвливаем новое значение при изменении поля
 */
ProductQuantity.prototype._setQuantity = function () {
  var self = this;

  self.quantity.toCheck = self._getQuantity();

  self._check();
};

/**
 * Проверка
 */
ProductQuantity.prototype._check = function () {
  var self = this;
  var _initState = _.clone(self.quantity);

  // если больше
  if (self.settings.max &amp;&amp; self.quantity.toCheck > self.quantity.max) {
    self.quantity.toCheck = self.quantity.max;
  }

  // ушли меньше возможного минимума
  if (isNaN(self.quantity.toCheck) || self.quantity.toCheck &lt; self.quantity.min) {
    self.quantity.toCheck = self.quantity.min;
  }

  self.quantityChanged = false;

  // после всех этих хитрых манипуляций у нас что-то изменилось?
  if (self.quantity.current !== self.quantity.toCheck) {
    self.quantity.current = self._fixValue(self.quantity.toCheck);
    self.quantityChanged = true;
  }
  // дергаем статусы
  self._update();
};

/**
 * Обновляем мир
 */
ProductQuantity.prototype._update = function () {
  var self = this;

  self.$input.val(self.quantity.current.toFixed(self.decimal));

  setTimeout(function () {
    var eventName = self.quantityChanged ? 'change_quantity' : 'unchange_quantity';
    self._owner._updateStatus({
      'event': eventName,
      method: 'update',
      instance: self,
    });
  }, 0);
};

/**
 * Вытаскиваем эекземпляр класса
 */
ProductQuantity.prototype._getInstance = function ($selector) {
  var self = this;
  var _instance = $selector.parents('['+ self.selectors.quantity+']')[0];

  if (_instance !== undefined) {
    _instance = _instance.Quantity
  } else {
    // если не нашли экземпляр - говорим, что продолбалось, отваливаемся
    console.warn('Product: Quantity', 'Не указан блок "Количество товаров" для', $selector);
    return false;
  }

  return _instance;
};

/**
 * Биндим события
 */
ProductQuantity.prototype._bindEvents = function () {
  var self = this;

  // очередной костыль в мой гроб
  if (document.ProductQuantity) {
    return false;
  };

  self._bindQuantityButtons();
  self._bindQuantityInput();

  document.ProductQuantity = true;
};

/**
 * Слушаем нажатия на кнопки +-
 */
ProductQuantity.prototype._bindQuantityButtons = function () {
  var self = this;

  $(document).on('click', '['+ self.selectors.quantityButton +']', function (event) {
    event.preventDefault();

    var $quantityButton = $(this);
    var quantity = self._getInstance($quantityButton);

    quantity._changeQuantity($quantityButton.data('quantity-change'));
  });
};

/**
 * Слушаем поле.
 */
ProductQuantity.prototype._bindQuantityInput = function () {
  var self = this;

  function _updateQuantity (event) {
    event.preventDefault();

    self._getInstance($(this))
      ._setQuantity();
  };

  $(document)
    .on('blur change', '['+ self.selectors.quantity +'] input[name]', _.debounce(_updateQuantity, 150))
    .on('keypress', '['+ self.selectors.quantity +'] input[name]', function (event) {
      if (event.keyCode == 13) {
        event.preventDefault();
        event.stopPropagation();

        self._getInstance($(this))
          ._setQuantity();
      }
    });
};

ProductQuantity.prototype._fixValue = function (_value) {
  var self = this;

  return _.chain(_value)
    .toFinite()
    .round(self.decimal)
    .value();
};

module.exports = ProductQuantity;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="cart_.html">ajaxAPI/cart</a></li><li><a href="checkout.html">ajaxAPI/checkout</a></li><li><a href="collection.html">ajaxAPI/collection</a></li><li><a href="compare_.html">ajaxAPI/compare</a></li><li><a href="product.html">ajaxAPI/product</a></li><li><a href="shop.html">ajaxAPI/shop</a></li><li><a href="RegTools.html">tools/RegTools</a></li><li><a href="singletone.html">tools/singletone</a></li><li><a href="translit.html">tools/translit</a></li></ul><h3>Classes</h3><ul><li><a href="Cart.html">Cart</a></li><li><a href="Cart.order.html">order</a></li><li><a href="Cart.quickCheckout.html">quickCheckout</a></li><li><a href="Cart.ui.html">ui</a></li><li><a href="Compare.html">Compare</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="Product_.html">Product</a></li><li><a href="ProductPriceType.html">ProductPriceType</a></li><li><a href="ProductVariants.html">ProductVariants</a></li><li><a href="Search.html">Search</a></li><li><a href="Shop_.html">Shop</a></li><li><a href="Shop.client.html">client</a></li><li><a href="Shop.money.html">money</a></li><li><a href="Template.html">Template</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Fri Jul 22 2016 15:51:58 GMT+0300 (MSK)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
