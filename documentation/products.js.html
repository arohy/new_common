<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: products/products.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: products/products.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @private */
var $ = require('jquery');
/** @private */
var _ = require('lodash');
/** @private */
var _Storage = require('./storage');
/** @private */
var _Product = require('../product/product');
/** @private */
var _Singleton = require('../tools/singleton');

/**
 * Централизованная работа с товарами
 * @class
 *
 */
var Products = function () {
  var self = this;

  // настройки
  self._settings = {};
  // объект с готовыми к употреблению товарами
  self._products = {};

  // массив с актуальными id (которые есть на странице +-)
  self._storage = new _Storage(self);

  self._init();
};

/**
 * Инициализация
 * @method
 *
 * @private
 */
Products.prototype._init = function () {
  var self = this;

  self._getDomId()
    .done(function (idList) {
      self._getList(idList);
    });
};

/**
 * Получаем готовый к употреблению товар
 * @method
 *
 * @param {number} id - id товара
 */
Products.prototype.get = function (id) {
  var self = this;

  id = _.toInteger(id);

  return self._getOne(id);
};

/**
 * Получение списка товаров
 * @method
 *
 * @param {Array} idList - массив, состоящий из id товаров
 */
Products.prototype.getList = function (idList) {
  var self = this;

  idList = _.toArray(idList);

  return self._getList(idList);
};

/**
 * Обновление настроек продуктов созданных через
 * @method
 *
 * @param {Object} settings - объект с применяемыми настройками. Применяется для всехэкземпляров на странице
 */
Products.prototype.setConfig = function (settings){
  var self = this;

  self._settings = settings;

  _.forEach(self._products, function (product) {
    product.settings.set(self._settings);
  });
};

/**
 * Получение списка из id из DOM
 * @method
 * @private
 */
Products.prototype._getDomId = function () {
  var self = this;
  var result = $.Deferred();
  var _idList = [];

  $(function () {
    $('[data-product-id]').each(function (index, form) {
      var id = _.toInteger($(form).data('product-id'));

      _idList.push(id);
    });

    result.resolve(_.uniq(_idList));
  });

  return result.promise();
};

/**
 * Получение списка товаров
 * @method
 * @private
 */
Products.prototype._getList = function (_idList) {
  var self = this;
  var result = $.Deferred();

  // проверить все ли товары инициализированны?
  var diffId = _.difference(_idList, self._actualId);

  if (diffId.length) {
    // чего-то нет
    // Забираем из харнилища
    self._storage.getProducts(diffId)
      .done(function (products) {
        // инитим товары
        _.forEach(products, function (product) {
          self._initProduct(product);
        });

        // отдаем результат
        result.resolve(_.pick(self._products, _idList));
      });
  } else {
    // всё есть - отдаем
    result.resolve(_.pick(self._products, _idList));
  }

  return result.promise();
};

/**
 * Получение информации о товаре
 * @method
 * @private
 */
Products.prototype._getOne = function (_id) {
  var self = this;
  var result = $.Deferred();

  // а по сути нужно сделать все тоже, что и в
  // _getList, но забрать первый элемент
  self._getList([_id])
    .done(function (products) {
      products = _.toArray(products);
      result.resolve(products[0]);
    });

  return result.promise();
};

/**
 * @method
 * @private
 */
Products.prototype._initProduct = function (_productJSON) {
  var self = this;

  self._products[_productJSON.id] = new _Product(_productJSON, self._settings);
};

module.exports = _Singleton(Products).getInstance();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="cart_.html">ajaxAPI/cart</a></li><li><a href="checkout.html">ajaxAPI/checkout</a></li><li><a href="collection.html">ajaxAPI/collection</a></li><li><a href="compare_.html">ajaxAPI/compare</a></li><li><a href="product.html">ajaxAPI/product</a></li><li><a href="shop.html">ajaxAPI/shop</a></li><li><a href="RegTools.html">tools/RegTools</a></li><li><a href="singletone.html">tools/singletone</a></li><li><a href="translit.html">tools/translit</a></li></ul><h3>Classes</h3><ul><li><a href="Cart.html">Cart</a></li><li><a href="Cart.order.html">order</a></li><li><a href="Cart.quickCheckout.html">quickCheckout</a></li><li><a href="Cart.ui.html">ui</a></li><li><a href="Compare.html">Compare</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="Product_.html">Product</a></li><li><a href="ProductPriceType.html">ProductPriceType</a></li><li><a href="Products.html">Products</a></li><li><a href="ProductVariants.html">ProductVariants</a></li><li><a href="Search.html">Search</a></li><li><a href="Shop_.html">Shop</a></li><li><a href="Shop.client.html">client</a></li><li><a href="Shop.money.html">money</a></li><li><a href="Template.html">Template</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Fri Jul 22 2016 17:00:02 GMT+0300 (MSK)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
